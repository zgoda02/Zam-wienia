<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>System Zam√≥wie≈Ñ ‚Äî Pe≈Çna wersja (od≈õwie≈ºona)</title>
  <meta name="robots" content="noindex" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüßæ%3C/text%3E%3C/svg%3E">
  <style>
    /* ================= Reset & Base ================= */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff;
      background:linear-gradient(135deg,#0b1220 0%,#5b1b84 50%,#0b1220 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:28px 22px}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none !important}

    /* ================= Spacing helpers ================= */
    .stack-s{display:flex;flex-direction:column;gap:8px}
    .stack-m{display:flex;flex-direction:column;gap:12px}
    .stack-l{display:flex;flex-direction:column;gap:18px}

    /* ================= Glass Cards ================= */
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:20px;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      box-shadow:0 12px 32px rgba(0,0,0,.45);
    }
    .card-title{font-weight:800;font-size:1.1rem;color:#c4b5fd;margin:0 0 10px}

    /* ================= Header & Buttons ================= */
    .app-header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-logo{
      width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      background:rgba(168,85,247,.2);border:1px solid rgba(196,181,253,.25);font-size:22px
    }
    .badge{
      background:rgba(249,115,22,.18);
      border:1px solid rgba(250,204,21,.18);
      color:#fde68a;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px
    }
    .btn{
      border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;transition:.2s transform
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:rgba(255,255,255,.06);color:#e5e7eb;border:1px solid rgba(255,255,255,.08)}
    .btn-primary{background:rgba(59,130,246,.2);color:#c4b5fd;border:1px solid rgba(147,197,253,.18)}
    .btn-success{background:rgba(34,197,94,.18);color:#bbf7d0;border:1px solid rgba(74,222,128,.15)}
    .btn-danger{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(248,113,113,.15)}
    .btn-warning{background:rgba(234,179,8,.18);color:#fde68a;border:1px solid rgba(250,204,21,.12)}

    /* ================= Select / Inputs ================= */
    .select,.input{
      appearance:none;-webkit-appearance:none;
      padding:10px 14px;font-weight:900;border-radius:10px;
      border:2px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.97);color:#0b1220;font-size:14px;outline:none;
      box-shadow:0 4px 10px rgba(11,18,32,.25)
    }
    .select:focus,.input:focus{border-color:rgba(168,85,247,.5);box-shadow:0 6px 18px rgba(24,24,48,.35)}

    /* ================= Toolbar (auto-wrap grid) ================= */
    .toolbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;align-items:center}
    .toolbar .btn,.toolbar label.btn{width:100%;justify-content:center}

    /* ================= Grid & Items ================= */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .item{position:relative;overflow:visible}
    .item .item-body{padding:12px}
    .item .item-name{font-weight:900;font-size:1rem;color:#fff}
    .item .price-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px;flex-wrap:wrap}
    .tier{font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(59,130,246,.15);color:#bfdbfe;border:1px solid rgba(147,197,253,.12);font-weight:800}
    .value{font-weight:900;padding:6px 10px;border-radius:8px;background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(74,222,128,.12)}
    .qty{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    .pill{min-width:38px;text-align:center;font-weight:900;background:rgba(255,255,255,.06);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.06)}

    /* ‚úñ corner delete: widoczny tylko dla admina */
    .corner-delete{
      position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:999px;border:none;
      background:rgba(239,68,68,.9);color:#fff;display:none;align-items:center;justify-content:center;
      font-weight:900;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.45)
    }
    body.admin .corner-delete{display:flex}

    /* Admin-only helper */
    .admin-only{display:none}
    body.admin .admin-only{display:inline-flex}

    /* ================= Modals ================= */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:60;padding:16px}
    .modal{max-width:960px;width:min(960px,96vw)}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .label{font-size:12px;opacity:.85}
    .input.dark{background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.12)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left;color:#c4b5fd;font-weight:900}

    /* ================= Toasts ================= */
    #toastStack{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:80}
    .toast{min-width:260px;max-width:360px;padding:12px 14px;border-radius:12px;color:#0b1220;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.35);font-weight:800;opacity:0;transform:translateY(-10px) scale(.98);animation:toast-in .18s ease-out forwards}
    .toast-success{background:#bbf7d0}
    .toast-error{background:#fecaca}
    .toast-info{background:#bfdbfe}
    .toast small{display:block;font-weight:600;opacity:.8;margin-top:4px}
    @keyframes toast-in{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes toast-out{to{opacity:0;transform:translateY(-8px) scale(.98)}}

    /* ================= Animacje usuwania ================= */
    @keyframes vanish{to{opacity:0;transform:translateY(-6px) scale(.98)}}
    .vanish{animation:vanish .25s ease forwards}

    /* ================= Responsive tweaks ================= */
    @media (max-width:840px){
      .controls-split{display:grid;grid-template-columns:1fr;gap:14px}
    }
    @media (max-width:520px){
      .brand-logo{width:40px;height:40px;font-size:18px}
      .select{font-size:13px;padding:8px 10px}
    }
  
    /* === Wygodniejsze przeglƒÖdanie historii === */
    #historyWrap table { table-layout: auto; width: 100%; }
    #historyWrap th, #historyWrap td { white-space: normal; word-break: break-word; overflow-wrap: anywhere; }
    @media (max-width: 600px) {
      .modal { max-width: 96vw; width: 96vw; }
      #historyWrap { max-height: 70vh; }
    }

  
    /* Przyciski w kolumnie Akcje w historii */
    #historyWrap .btn { margin-right: 6px; }

  </style>
</head>
<body>
  <!-- ================ LOGIN ================ -->
  <section id="loginScreen" class="center" style="height:100vh;padding:24px">
    <div class="card" style="max-width:460px;text-align:center">
      <div style="font-size:22px;font-weight:900;margin-bottom:6px">üîê System Zam√≥wie≈Ñ</div>
      <div class="kicker" style="opacity:.9">Zaloguj siƒô jako Go≈õƒá lub Administrator</div>
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:10px">
        <button class="btn btn-success" onclick="login('guest')">üë§ Zaloguj jako Go≈õƒá</button>
        <button class="btn btn-primary" onclick="openAdminLogin()">‚öôÔ∏è Panel Administratora</button>
      </div>
    </div>
  </section>

  <!-- ================ APP ================ -->
  <main id="mainApp" class="hidden">
    <div class="container stack-l">
      <!-- Header -->
      <div class="card app-header">
        <div class="brand">
          <div class="brand-logo">üßÆ</div>
          <div>
            <div style="font-weight:900">System Zam√≥wie≈Ñ</div>
            <div class="kicker" style="opacity:.9">Dane w przeglƒÖdarce.</div>
          </div>
        </div>
        <div class="row">
          <span id="userBadge" class="badge">Go≈õƒá</span>
          <button class="btn btn-ghost" onclick="logout()">üö™ Wyloguj</button>
        </div>
      </div>

      <!-- Controls (podzielone i niewchodzƒÖce na siebie) -->
      <div class="card stack-m">
        <div class="controls-split" style="display:grid;grid-template-columns:1fr auto;gap:18px;align-items:center">
          <div class="row" style="align-items:center;gap:12px">
            <label for="tierSelect" style="font-weight:800;color:#cbd5e1">Rodzaj u≈ºytkownika</label>
            <select id="tierSelect" class="select" onchange="setTier(this.value)">
              <option value="H">Cz≈Çonek (H)</option>
              <option value="S">Zas≈Çu≈ºony (S)</option>
            </select>
          </div>
          <!-- Wyszukiwarka -->
          <div class="row" style="justify-content:flex-end;gap:10px">
            <input id="searchInput" class="input" placeholder="Szukaj przedmiotu..." oninput="setSearch(this.value)" />
          </div>
        </div>

        <!-- Pasek narzƒôdzi admina w siatce - ju≈º siƒô nie nak≈Çada i ≈Çadnie siƒô ≈Çamie -->
        <div class="toolbar admin-only">
          <button id="editBtn" class="btn btn-warning" onclick="toggleEditMode()">‚úèÔ∏è Tryb edycji: WY≈Å</button>
          <button class="btn btn-success" onclick="openAddModal()">‚ûï Dodaj przedmiot</button>
          <button class="btn btn-primary" onclick="exportData()">üì¶ Eksport</button>
          <label class="btn btn-ghost" for="importFile">üì• Import JSON</label>
          <input id="importFile" class="hidden" type="file" accept="application/json" onchange="importData(event)">
          <button class="btn btn-ghost" onclick="openHistory()">üìú Historia zam√≥wie≈Ñ</button>
        
  <button class="btn btn-primary" onclick="openActivityClean()">üìä Aktywno≈õƒá</button>
</div>
      </div>

      <!-- Categories -->
      <section class="row" style="gap:18px">
        <div class="card" style="flex:1 1 360px;min-width:300px">
          <h3 class="card-title">üî´ Klamoty</h3>
          <div id="cat-klamoty" class="grid"></div>
        </div>
        <div class="card" style="flex:1 1 360px;min-width:300px">
          <h3 class="card-title">üõ°Ô∏è Dodatki</h3>
          <div id="cat-dodatki" class="grid"></div>
        </div>
        <div class="card" style="flex:1 1 360px;min-width:300px">
          <h3 class="card-title">üîπ Ammo</h3>
          <div id="cat-ammo" class="grid"></div>
        </div>
      </section>

      <!-- Summary -->
      <div class="card" style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap">
  <div class="totals" style="font-weight:900;background:rgba(168,85,247,.22);border:1px solid rgba(196,181,253,.3);padding:10px 14px;border-radius:10px">
    Przedmioty: <span id="totalCount">0</span> &nbsp;|&nbsp; Suma: <span id="totalPrice">0$</span>
  </div>
  <div class="row">
    <div class="row" style="gap:10px;align-items:center;margin-right:10px">
      <label for="orderUserName" style="font-weight:800;color:#cbd5e1">U≈ºytkownik</label>
      <input id="orderUserName" class="input" style="min-width:220px" placeholder="np. Jan Kowalski" oninput="setOrderUser(this.value)" />
    </div>

    <button class="btn btn-danger" onclick="resetCart()">üßπ Wyzeruj koszyk</button>
    <button class="btn btn-ghost" onclick="downloadCartHTML()">‚¨áÔ∏è Pobierz podsumowanie (HTML)</button>
    <button class="btn btn-success" onclick="placeOrder()">‚úÖ Z≈Ç√≥≈º zam√≥wienie</button>
  </div>
  <div id="cartSummaryList" class="card" style="flex:1 1 100%;background:rgba(255,255,255,.04)">
    <h3 class="card-title">üìã Przedmioty do zakupu</h3>
    <div id="cartSummaryTableWrap"></div>
  </div>
</div>

      <!-- Export preview -->
      <div id="exportPreview" class="card hidden">
        <h3 class="card-title">PodglƒÖd danych</h3>
        <div id="exportTableWrap"></div>
      </div>
    </div>
  </main>

  <!-- ================ ADD ITEM MODAL ================ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="card modal">
      <h3 class="card-title">‚ûï Dodaj nowy przedmiot</h3>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="field" style="flex:1 1 160px">
          <label class="label">Kategoria</label>
          <select id="newCategory" class="input dark">
            <option value="klamoty">Klamoty</option>
            <option value="dodatki">Dodatki</option>
            <option value="ammo">Ammo</option>
          </select>
        </div>
        <div class="field" style="flex:1 1 160px">
          <label class="label">Id (unikalne, bez spacji)</label>
          <input id="newId" class="input dark" placeholder="np. vintek">
        </div>
      </div>
      <div class="field">
        <label class="label">Nazwa</label>
        <input id="newName" class="input dark" placeholder="np. Vintek">
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="field" style="flex:1 1 160px">
          <label class="label">Cena Cz≈Çonek (H)</label>
          <input id="newPriceH" type="number" class="input dark" placeholder="np. 300000">
        </div>
        <div class="field" style="flex:1 1 160px">
          <label class="label">Cena Zas≈Çu≈ºony (S)</label>
          <input id="newPriceS" type="number" class="input dark" placeholder="np. 270000">
        </div>
      </div>
      <div class="field">
        <label class="label">Jednostka (opcjonalnie)</label>
        <input id="newUnit" class="input dark" placeholder="np. szt.">
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeAddModal()">Anuluj</button>
        <button class="btn btn-success" onclick="saveNewItem()">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- ================ ADMIN LOGIN MODAL ================ -->
  <div id="adminLoginModal" class="modal-backdrop">
    <div class="card modal">
      <h3 class="card-title">üîë Logowanie Administratora</h3>
      <div class="field">
        <label class="label">Login</label>
        <input id="adminLogin" class="input dark" placeholder="admin">
      </div>
      <div class="field">
        <label class="label">Has≈Ço</label>
        <input id="adminPass" type="password" class="input dark" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn btn-ghost" onclick="closeAdminLogin()">Anuluj</button>
        <button class="btn btn-primary" onclick="submitAdminLogin()">Zaloguj</button>
      </div>
      <div style="margin-top:10px;font-size:13px;color:#cbd5e1">Demo: dowolny login, has≈Ço <b></b>.</div>
    </div>
  </div>

  <!-- ================ HISTORY MODAL ================ -->
  <div id="historyModal" class="modal-backdrop">
    <div class="card modal">
      <h3 class="card-title">üìú Historia zam√≥wie≈Ñ</h3>
      <div id="historyWrap" style="max-height:78vh;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="row">
          <button class="btn btn-ghost" onclick="exportHistory()">‚¨áÔ∏è Eksport historii</button>
          <button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Wyczy≈õƒá historiƒô</button>
        </div>
        <div class="row">
          <button class="btn btn-primary" onclick="closeHistory()">Zamknij</button>
        </div>
      </div>
      <small style="opacity:.85">Historia jest zapisywana lokalnie w Twojej przeglƒÖdarce.</small>
    </div>
  </div>

  <!-- Toast stack -->
  <div id="toastStack"></div>

  <script>
    /* ===================== Helpers / State ===================== */
    /* === Admin password verification (hashed) === */
    const ADMIN_HASH = "e03860fc11924d115834b0f307ccf3863795a9380fa9599d29036a34aeffb902";
    

    // --- Minimal SHA-256 fallback (pure JS) ---
    function sha256Hex_fallback(ascii) {
      function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }
      var mathPow=Math.pow; var maxWord=mathPow(2, 32); var lengthProperty='length';
      var i, j; var result=''; var words=[]; var asciiBitLength=ascii[lengthProperty]*8;
      var hash = sha256Hex_fallback.h = sha256Hex_fallback.h || [];
      var k = sha256Hex_fallback.k = sha256Hex_fallback.k || [];
      var primeCounter = k[lengthProperty];
      if(!primeCounter){
        var isPrime = {}; var candidate=2;
        while(primeCounter<64){
          var isP = !isPrime[candidate];
          if(isP){
            for(i=0;i<313;i+=candidate){ isPrime[i*candidate]=true; }
            hash[primeCounter] = (mathPow(candidate, .5)*maxWord)|0;
            k[primeCounter++] = (mathPow(candidate, 1/3)*maxWord)|0;
          }
          candidate++;
        }
      }
      ascii += '\x80'; while(ascii[lengthProperty]%64-56) ascii+='\x00';
      for(i=0;i<ascii[lengthProperty]; i++){
        j=ascii.charCodeAt(i);
        if(j>>8) return; // ASCII only
        words[i>>2] |= j << ((3 - i)%4)*8;
      }
      words[words[lengthProperty]] = ((asciiBitLength/maxWord)|0);
      words[words[lengthProperty]] = (asciiBitLength)
      for(j=0; j<words[lengthProperty];){
        var w = words.slice(j, j+=16); var oldHash = hash.slice(0);
        for(i=0;i<64;i++){
          var w15 = w[i - 15], w2 = w[i - 2];
          var a = hash[0], e = hash[4];
          var temp1 = hash[7]
            + (rightRotate(e,6)^rightRotate(e,11)^rightRotate(e,25))
            + ((e&hash[5])^((~e)&hash[6]))
            + k[i]
            + (w[i] = (i<16) ? w[i] : (
                w[i-16]
                + (rightRotate(w15,7)^rightRotate(w15,18)^(w15>>>3))
                + w[i-7]
                + (rightRotate(w2,17)^rightRotate(w2,19)^(w2>>>10))
              )|0);
          var temp2 = (rightRotate(a,2)^rightRotate(a,13)^rightRotate(a,22))
            + ((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));
          hash = [(temp1+temp2)|0].concat(hash); hash[4] = (hash[4]+temp1)|0;
          hash.pop();
        }
        for(i=0;i<8;i++){ hash[i] = (hash[i]+oldHash[i])|0; }
      }
      for(i=0;i<8;i++){
        for(j=3;j+1;j--){
          var b = (hash[i]>>(j*8))&255;
          result += ((b<16)?0:'') + b.toString(16);
        }
      }
      return result;
    }

const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
    async function sha256Hex(v) {
      try {
        if (window.crypto && crypto.subtle) {
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(v));
          const arr = Array.from(new Uint8Array(buf));
          return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
        }
      } catch (e) { /* fall back below */ }
      return sha256Hex_fallback(unescape(encodeURIComponent(v)));
    }
    async function verifyPass(p) {
      try { return (await sha256Hex(p)) === ADMIN_HASH; }
      catch { return false; }
    }

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    let currentUser = null;   // 'guest' | 'admin'
    let currentTier = 'H';    // 'H' | 'S'
    let editMode = false;
    let cart = {};
    let items = {};
    let query = '';

    const DEFAULT_DATA = {
      klamoty: {
        vintek:   { name:'Vintek',    unit:'',    prices:{ H:300000, S:270000 } },
        pistol:   { name:'Pistolet',  unit:'',    prices:{ H: 75000, S: 50000 } },
        taser:    { name:'Taser',     unit:'',    prices:{ H:120000, S:100000 } }
      },
      dodatki: {
        kajdanki: { name:'Kajdanki',  unit:'',    prices:{ H:150000, S:125000 } },
        kamizelka:{ name:'Kamizelka', unit:'',    prices:{ H:250000, S:200000 } },
        latarka:  { name:'Latarka',   unit:'',    prices:{ H: 15000, S: 10000 } }
      },
      ammo: {
        ammo9:    { name:'Ammo 9mm',  unit:'szt.',prices:{ H:  1500, S:  1250 } },
        ammo556:  { name:'Ammo 5.56', unit:'szt.',prices:{ H:  2500, S:  2200 } }
      }
    };

    /* ===================== UI Utils ===================== */
    function formatPrice(n){
      return n+'$';
    }
    function parsePrice(str){
      const s=(str||'').toString().trim().toLowerCase().replace(/\$/g,'').replace(/\s/g,'');
      if(!s) return NaN;
      if(/m$/.test(s)) return Math.round(parseFloat(s)*1_000_000);
      if(/k$/.test(s)) return Math.round(parseFloat(s)*1_000);
      return parseInt(s,10);
    }
    function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]))}
    function uid(){return 'o_'+Math.random().toString(36).slice(2)+Date.now().toString(36)}

    /* ===================== Toasts ===================== */
    function showToast(msg,type='info',subtitle=''){
      const stack = $('#toastStack');
      const t = document.createElement('div');
      t.className = `toast toast-${type}`;
      t.innerHTML = `${escapeHtml(msg)}${subtitle?`<small>${escapeHtml(subtitle)}</small>`:''}`;
      stack.appendChild(t);
      const close = ()=>{ t.style.animation = 'toast-out .16s ease forwards'; setTimeout(()=>t.remove(),160); };
      setTimeout(close, 2800);
      t.addEventListener('click', close);
    }

    /* ===================== Search ===================== */
    function setSearch(v){
      query=(v||'').toLowerCase();
      renderAll();
    }

    /* ===================== Auth & Tier ===================== */
    function openAdminLogin(){ $('#adminLoginModal').style.display='flex'; setTimeout(()=>$('#adminLogin').focus(),50); }
    function closeAdminLogin(){ $('#adminLoginModal').style.display='none'; }
    async function submitAdminLogin(){
      const pass=$('#adminPass').value;
      const ok = await verifyPass(pass);
      if(ok){ closeAdminLogin(); login('admin'); showToast('Zalogowano jako Administrator','success'); }
      else { await sleep(400); showToast('Nieprawid≈Çowe has≈Ço','error'); }
}

    function login(type){
      setTimeout(ensureUserInputMounted, 50);
      currentUser=type;
      $('#loginScreen').classList.add('hidden');
      $('#mainApp').classList.remove('hidden');
      $('#userBadge').textContent = type==='admin' ? 'Administrator' : 'Go≈õƒá';
      document.body.classList.toggle('admin', type==='admin');
      $$('.admin-only').forEach(el=> el.style.display = (type==='admin') ? '' : 'none');
      loadState();
      renderAll();
    }
    function logout(){ currentUser=null; document.body.classList.remove('admin'); location.reload(); }
    function setTier(v){ currentTier=v; saveState(); renderAll(); showToast('Zmieniono rodzaj u≈ºytkownika','info', v==='H'?'Cz≈Çonek (H)':'Zas≈Çu≈ºony (S)'); }

    /* ===================== Storage ===================== */
    function loadState(){
      const savedItems = localStorage.getItem('itemsData');
      items = savedItems ? JSON.parse(savedItems) : JSON.parse(JSON.stringify(DEFAULT_DATA));
      const savedTier = localStorage.getItem('tier');
      if(savedTier){ currentTier=savedTier; $('#tierSelect').value=currentTier; }
      initCart();
    }
    function saveState(){
      localStorage.setItem('itemsData', JSON.stringify(items));
      localStorage.setItem('tier', currentTier);
    }

    /* ===================== Cart ===================== */
    function initCart(){
      cart={};
      Object.keys(items).forEach(cat=>Object.keys(items[cat]).forEach(id=>cart[id]=0));
      updateTotals();
    }
    function changeQty(id,delta){
      cart[id]=Math.max(0,(cart[id]||0)+delta);
      const pill=$('#qty-'+id); if(pill) pill.textContent=cart[id];
      updateTotals();
    }
    
    function setQty(id, v){
      let n = parseInt(v,10);
      if (isNaN(n) || n < 0) n = 0;
      cart[id] = n;
      const pill = $('#qty-'+id); if(pill && pill.textContent != String(n)) pill.textContent = n;
      updateTotals();
    }
function updateTotals(){
      renderCartSummaryList();
      ensureUserInputMounted();
      let count=0,sum=0;
      Object.keys(items).forEach(cat=>{
        Object.keys(items[cat]).forEach(id=>{
          const it=items[cat][id];
          if(query && !it.name.toLowerCase().includes(query)) return; // filtr sumy zgodnie z widokiem
          const q=cart[id]||0;
          count+=q; sum+= q*(it.prices[currentTier]||0);
        });
      });
      $('#totalCount').textContent=count;
      $('#totalPrice').textContent=formatPrice(sum);
    }
    function resetCart(){
      renderCartSummaryList();
      ensureUserInputMounted();
      Object.keys(cart).forEach(k=>cart[k]=0);
      $$('[id^="qty-"]').forEach(p=>p.textContent='0');
      updateTotals();
      showToast('Koszyk wyczyszczony','info');
    }

    /* ===================== Render ===================== */
    function renderAll(){
      renderCartSummaryList();
      ensureUserInputMounted();
      renderCategory('klamoty','#cat-klamoty');
      renderCategory('dodatki','#cat-dodatki');
      renderCategory('ammo','#cat-ammo');
      updateTotals();
    }
    function renderCategory(catKey, mountSel){
      const mount=$(mountSel); mount.innerHTML='';
      const data=items[catKey]||{};
      Object.keys(data).forEach(id=>{
        const it=data[id];
        if(query && !it.name.toLowerCase().includes(query)) return; // filtr po nazwie
        const card=document.createElement('div');
        card.className='item card';
        card.setAttribute('data-key', `${catKey}:${id}`);
        card.innerHTML=`
          <button class="corner-delete" title="Usu≈Ñ" onclick="deleteItem('${catKey}','${id}', this)">‚úñ</button>
          <div class="item-body">
            <div class="item-name" ${editMode?'contenteditable="true"':''} data-field="name" data-id="${id}" data-cat="${catKey}">${escapeHtml(it.name)}</div>
            <div class="price-row">
              <div class="tier">Cennik: ${currentTier==='H'?'Cz≈Çonek (H)':'Zas≈Çu≈ºony (S)'} ${it.unit?`¬∑ ${escapeHtml(it.unit)}`:''}</div>
              <div class="value" ${editMode?'contenteditable="true"':''} data-field="price" data-id="${id}" data-cat="${catKey}">${formatPrice(it.prices[currentTier])}</div>
            </div>
            <div class="qty">
              <button class="btn btn-danger" onclick="changeQty('${id}',-1)">‚àí</button>
              <div class="pill" id="qty-${id}" contenteditable="true" oninput="setQty('${id}', this.textContent)">${cart[id]||0}</div>
              <button class="btn btn-success" onclick="changeQty('${id}',1)">+</button>
              <div style="flex:1"></div>
              <button class="btn btn-ghost admin-only ${editMode?'':'hidden'}" onclick="deleteItem('${catKey}','${id}', this)">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        `;
        mount.appendChild(card);
      });

      if(editMode){
        mount.querySelectorAll('[contenteditable="true"]').forEach(el=>{
          el.addEventListener('blur', handleEditBlur);
          el.addEventListener('keydown', e=>{if(e.key==='Enter'){e.preventDefault(); el.blur();}});
        });
      }
    }
    function handleEditBlur(e){
      const el=e.target;
      const id=el.getAttribute('data-id');
      const cat=el.getAttribute('data-cat');
      const field=el.getAttribute('data-field');
      if(field==='name'){
        const val=el.textContent.trim();
        if(val){ items[cat][id].name=val; showToast('Zmieniono nazwƒô','success', val); }
        else el.textContent = items[cat][id].name;
      }else if(field==='price'){
        const parsed = parsePrice(el.textContent);
        if(!isNaN(parsed)){ items[cat][id].prices[currentTier]=parsed; el.textContent=formatPrice(parsed); showToast('Zmieniono cenƒô','success', formatPrice(parsed)); }
        else el.textContent = formatPrice(items[cat][id].prices[currentTier]);
      }
      saveState(); updateTotals();
    }

    /* ===================== Deleting with animation ===================== */
    function deleteItem(cat,id,btn){
      if(currentUser!=='admin') return;
      if(!confirm(`Na pewno usunƒÖƒá ‚Äû${items[cat][id].name}‚Äù?`)) return;
      const card = document.querySelector(`[data-key="${cat}:${id}"]`);
      const after = ()=>{
        delete items[cat][id];
        delete cart[id];
        saveState();
        renderAll();
        showToast('Usuniƒôto przedmiot','success', id);
      };
      if(card){
        card.classList.add('vanish');
        card.addEventListener('animationend', after, { once:true });
      }else after();
    }

    /* ===================== Add Item Modal ===================== */
    function openAddModal(){
      if(currentUser!=='admin') return;
      $('#modalBackdrop').style.display='flex';
      $('#newCategory').value='klamoty';
      $('#newId').value=''; $('#newName').value='';
      $('#newPriceH').value=''; $('#newPriceS').value='';
      $('#newUnit').value='';
      setTimeout(()=>$('#newId').focus(),60);
    }
    function closeAddModal(){ $('#modalBackdrop').style.display='none'; }
    function saveNewItem(){
      const cat=$('#newCategory').value;
      const id=($('#newId').value||'').trim();
      const name=($('#newName').value||'').trim();
      const pH=parseInt($('#newPriceH').value,10);
      const pS=parseInt($('#newPriceS').value,10);
      const unit=($('#newUnit').value||'').trim();
      if(!id || !name || isNaN(pH) || isNaN(pS)){ showToast('Uzupe≈Çnij ID, nazwƒô i obie ceny','error'); return; }
      if(!items[cat]) items[cat]={};
      if(items[cat][id]){ showToast('ID ju≈º istnieje','error', id); return; }
      items[cat][id]={ name, unit, prices:{H:pH,S:pS} };
      cart[id]=0;
      saveState(); closeAddModal(); renderAll();
      showToast('Dodano przedmiot','success', name);
    }

    /* ===================== Export / Import ===================== */
    function exportData(){
      const data = { items, meta:{ exportedAt:new Date().toISOString(), tier:currentTier } };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='items-export.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      previewExport();
      showToast('Wyeksportowano dane','success');
    }
    function previewExport(){
      const wrap=$('#exportTableWrap'); wrap.innerHTML='';
      const tbl=document.createElement('table');
      tbl.innerHTML = `<thead><tr><th>Kategoria</th><th>ID</th><th>Nazwa</th><th>Jednostka</th><th>Cena H</th><th>Cena S</th></tr></thead>`;
      const tbody=document.createElement('tbody');
      Object.keys(items).forEach(cat=>{
        Object.keys(items[cat]).forEach(id=>{
          const it=items[cat][id];
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${cat}</td><td>${id}</td><td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.unit||'')}</td><td>${it.prices.H}</td><td>${it.prices.S}</td>`;
          tbody.appendChild(tr);
        });
      });
      tbl.appendChild(tbody); wrap.appendChild(tbl);
      $('#exportPreview').classList.remove('hidden');
    }
    function importData(evt){
      const file=evt.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=(e)=>{
        try{
          const data=JSON.parse(e.target.result);
          if(!data.items) throw new Error('Brak pola items.');
          items=data.items; saveState(); initCart(); renderAll();
          const totalItems = Object.values(items).reduce((a,cat)=>a+Object.keys(cat).length,0);
          showToast('Zaimportowano dane','success', `Pozycji: ${totalItems}`);
        }catch(err){ showToast('B≈ÇƒÖd importu','error', err.message); }
        evt.target.value='';
      };
      reader.readAsText(file);
    }

    /* ===================== Orders & History ===================== */

    /* ===================== Order User (name) ===================== */
    const ORDER_USER_KEY = 'orderUserName';
    function setOrderUser(v){
      try{ localStorage.setItem(ORDER_USER_KEY, (v||'').toString()); }catch{}
    }
    function getOrderUser(){
      try{ return (localStorage.getItem(ORDER_USER_KEY)||'').toString().trim(); }catch{ return ''; }
    }
    function ensureUserInputMounted(){
      const el = document.getElementById('orderUserName');
      if(!el) return;
      const saved = getOrderUser();
      if(saved && el.value !== saved){ el.value = saved; }
    }


    /* ===================== Live Cart Summary ===================== */
    function renderCartSummaryList(){
      const wrap = document.getElementById('cartSummaryTableWrap');
      if(!wrap) return;

      // Zbierz pozycje z koszyka (bez filtra wyszukiwarki)
      const lines = [];
      let total = 0;
      let totalQty = 0;
      Object.keys(items).forEach(cat=>{
        Object.keys(items[cat]).forEach(id=>{
          const it = items[cat][id];
          const q = cart[id]||0;
          if(q>0){
            const price = it.prices[currentTier]||0;
            const sub = q*price;
            total += sub;
            totalQty += q;
            lines.push({cat,id,name:it.name,unit:it.unit||'',qty:q,price,subtotal:sub});
          }
        });
      });

      if(lines.length===0){
        wrap.innerHTML = '<div style="opacity:.85">Koszyk jest pusty.</div>';
        return;
      }

      const rows = lines.map(l=>`
        <tr>
          <td>${escapeHtml(l.cat)}</td>
          <td>${escapeHtml(l.name)}</td>
          <td>${escapeHtml(l.unit||'')}</td>
          <td style="text-align:right">${escapeHtml(String(l.qty))}</td>
          <td style="text-align:right">${formatPrice(l.price)}</td>
          <td style="text-align:right">${formatPrice(l.subtotal)}</td>
        </tr>
      `).join('');

      wrap.innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Kategoria</th>
                <th>Nazwa</th>
                <th>Jedn.</th>
                <th style="text-align:right">Ilo≈õƒá</th>
                <th style="text-align:right">Cena</th>
                <th style="text-align:right">Suma</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <th colspan="3" style="text-align:right">Razem</th>
                <th style="text-align:right">${escapeHtml(String(totalQty))}</th>
                <th></th>
                <th style="text-align:right">${formatPrice(total)}</th>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    }

    /* ===================== HTML Report (Download) ===================== */
    function downloadCartHTML() {
      const lines = [];
      let totalH = 0, totalS = 0, totalQty = 0;

      Object.keys(items).forEach(cat=>{
        Object.keys(items[cat]).forEach(id=>{
          const it = items[cat][id];
          const q = cart[id]||0;
          if(q>0){
            const priceH = it.prices.H||0;
            const priceS = it.prices.S||0;
            const subH = q*priceH;
            const subS = q*priceS;
            totalH += subH; totalS += subS; totalQty += q;
            lines.push({cat,id,name:it.name,unit:it.unit||'',qty:q,priceH,priceS,subH,subS});
          }
        });
      });

      if(lines.length===0){ showToast('Koszyk jest pusty ‚Äî dodaj ilo≈õci', 'error'); return; }

      const now = new Date();
      const pad = n=> String(n).padStart(2,'0');
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
      const fmt = (n)=> (Math.round(n)||0).toLocaleString('pl-PL');
      const m0 = (n)=> `${fmt(n)} $`;

      const rows = lines.map(l=>`
        <tr>
          <td>${escapeHtml(l.cat)}</td>
          <td>${escapeHtml(l.name)}</td>
          <td>${escapeHtml(l.unit)}</td>
          <td style="text-align:right">${l.qty}</td>
          <td style="text-align:right">${m0(l.priceH)}</td>
          <td style="text-align:right">${m0(l.priceS)}</td>
          <td style="text-align:right">${m0(l.subH)}</td>
          <td style="text-align:right">${m0(l.subS)}</td>
        </tr>
      `).join('');

      const diff = totalH - totalS;
      const avgH = totalQty ? (totalH/totalQty) : 0;
      const avgS = totalQty ? (totalS/totalQty) : 0;
      const savePerItem = totalQty ? (diff/totalQty) : 0;
      const m2 = (n)=> `${(n||0).toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2})} $`;

      const html = `<!DOCTYPE html>
<html lang="pl"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Podsumowanie koszyka ‚Äî ${stamp}</title>
<style>
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#e5e7eb;
       background:linear-gradient(135deg,#0b1220 0%,#5b1b84 50%,#0b1220 100%);} .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px}
  h1{margin:0 0 6px} .kicker{opacity:.85;margin-bottom:12px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)} th{color:#c4b5fd;text-align:left}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:14px}
  .metric{display:flex;justify-content:space-between;gap:12px;font-weight:800}
  .metric .lab{color:#c4b5fd} .metric .val{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:8px}

    /* === Wygodniejsze przeglƒÖdanie historii === */
    #historyWrap table { table-layout: auto; width: 100%; }
    #historyWrap th, #historyWrap td { white-space: normal; word-break: break-word; overflow-wrap: anywhere; }
    @media (max-width: 600px) {
      .modal { max-width: 96vw; width: 96vw; }
      #historyWrap { max-height: 70vh; }
    }

  
    /* Przyciski w kolumnie Akcje w historii */
    #historyWrap .btn { margin-right: 6px; }

  </style></head><body>
<div class="wrap">
  <h1>üßæ Podsumowanie koszyka</h1>
  <div class="kicker">Wygenerowano ${now.toLocaleString('pl-PL')}</div>
  <div class="grid">
    <div class="card">
      <div class="metric"><span class="lab">≈ÅƒÖczna liczba przedmiot√≥w</span><span class="val">${totalQty}</span></div>
      <div class="metric"><span class="lab">Suma (H)</span><span class="val">${m0(totalH)}</span></div>
      <div class="metric"><span class="lab">Suma (S)</span><span class="val">${m0(totalS)}</span></div>
      <div class="metric"><span class="lab">R√≥≈ºnica H ‚àí S</span><span class="val">${m0(diff)}</span></div>
    </div>
    <div class="card">
      <div class="metric"><span class="lab">≈ör. cena / szt. (H)</span><span class="val">${m2(avgH)}</span></div>
      <div class="metric"><span class="lab">≈ör. cena / szt. (S)</span><span class="val">${m2(avgS)}</span></div>
      <div class="metric"><span class="lab">Oszczƒôdno≈õƒá / szt. (S vs H)</span><span class="val">${m2(savePerItem)}</span></div>
    </div>
  </div>
  <div class="card">
    <h2 style="margin:0 0 6px">Pozycje</h2>
    <table>
      <thead><tr>
        <th>Kategoria</th><th>Nazwa</th><th>Jedn.</th>
        <th style="text-align:right">Ilo≈õƒá</th>
        <th style="text-align:right">Cena H</th><th style="text-align:right">Cena S</th>
        <th style="text-align:right">Suma H</th><th style="text-align:right">Suma S</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>
</div>
</body></html>`;

      const blob = new Blob([html], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `podsumowanie_koszyka_${stamp}.html`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function placeOrder(){
      const orderUser = getOrderUser();
      ensureUserInputMounted();
      if(!orderUser){ showToast('Podaj nazwƒô u≈ºytkownika sk≈ÇadajƒÖcego zam√≥wienie','error'); return; }
      const lines=[];
      Object.keys(items).forEach(cat=>{
        Object.keys(items[cat]).forEach(id=>{
          const it=items[cat][id];
          if(query && !it.name.toLowerCase().includes(query)) return; // tylko widoczne
          const q=cart[id]||0;
          if(q>0){
            const price=it.prices[currentTier]||0;
            lines.push({id, name:it.name, unit:it.unit, qty:q, price, subtotal:q*price});
          }
        });
      });
      if(lines.length===0){ showToast('Koszyk jest pusty','error'); return; }
      const total = lines.reduce((a,b)=>a+b.subtotal,0);
      const order = { id:uid(), at:new Date().toISOString(), tier:currentTier, user:orderUser, items:lines, total };
      addOrderToHistory(order);
      showToast('Zam√≥wienie z≈Ço≈ºone','success', `Suma: ${formatPrice(total)}`);
      resetCart();
    }
    function getHistory(){
      try{ return JSON.parse(localStorage.getItem('orderHistory')||'[]'); }
      catch{ return []; }
    }
    function saveHistory(arr){ localStorage.setItem('orderHistory', JSON.stringify(arr)); }
    function addOrderToHistory(order){ const hist=getHistory(); hist.unshift(order); saveHistory(hist); }

    function openHistory(){ $('#historyModal').style.display='flex'; renderHistory(); }
    function closeHistory(){ $('#historyModal').style.display='none'; }
    function renderHistory(){
      const wrap=$('#historyWrap'); wrap.innerHTML='';
      const hist=getHistory();
      if(hist.length===0){ wrap.innerHTML='<div class="card" style="background:rgba(255,255,255,.04)">Brak zam√≥wie≈Ñ.</div>'; return; }
      const tbl=document.createElement('table');
      const thead=document.createElement('thead');
      thead.innerHTML='<tr><th>Data</th><th>ID</th><th>U≈ºytkownik</th><th>Pozycje</th><th>Tier</th><th>Suma</th><th>Akcje</th></tr>';
      const tbody=document.createElement('tbody');
      hist.forEach(o=>{
        const tr=document.createElement('tr');
        const date=new Date(o.at).toLocaleString();
        const count=o.items.reduce((a,b)=>a+b.qty,0);
        tr.innerHTML=`
          <td>${date}</td>
          <td>${o.id}</td>
          <td>${escapeHtml(o.user||"-")}</td>
          <td>${count}</td>
          <td>${o.tier}</td>
          <td>${formatPrice(o.total)}</td>
          <td>
            <button class="btn btn-success" onclick='restoreOrder("${o.id}")' title="Odtw√≥rz koszyk z tego zam√≥wienia">Odtw√≥rz</button>
            <button class="btn btn-danger" onclick='deleteOrder("${o.id}")' title="Usu≈Ñ to zam√≥wienie">Usu≈Ñ</button>
          </td>
        `;
        tbody.appendChild(tr);
        const det=document.createElement('tr');
        const details = o.items.map(it=>`${escapeHtml(it.name)} √ó ${it.qty} ‚Äî ${formatPrice(it.price)} = ${formatPrice(it.subtotal)}`).join('<br>');
        det.innerHTML = `<td colspan="7" style="font-size:13px;opacity:.9"><b>U≈ºytkownik:</b> ${escapeHtml(o.user||"-")}<br>${details}</td>`;
        tbody.appendChild(det);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody); wrap.appendChild(tbl);
    }
    function restoreOrder(orderId){
      const hist=getHistory();
      const o=hist.find(x=>x.id===orderId);
      if(!o){ showToast('Nie znaleziono zam√≥wienia','error'); return; }
      let restored=0, missing=0;
      Object.keys(cart).forEach(k=>cart[k]=0);
      o.items.forEach(it=>{
        if(findItemById(it.id)){ cart[it.id]=it.qty; restored+=it.qty; }
        else missing+=it.qty;
      });
      renderAll();
      // sync inputs with restored quantities
      Object.keys(cart).forEach(id=>{ const inp=document.getElementById('qtyInput-'+id); if(inp) inp.value = cart[id]||0; });
      showToast('Odtworzono koszyk','success', `Przywr√≥cono: ${restored}${missing?`, brakujƒÖce: ${missing}`:''}`);
      closeHistory();
    }
    function findItemById(id){
      for(const cat of Object.keys(items)){ if(items[cat][id]) return items[cat][id]; }
      return null;
    }
    function clearHistory(){
      if(!confirm('Wyczy≈õciƒá ca≈ÇƒÖ historiƒô zam√≥wie≈Ñ?')) return;
      saveHistory([]); renderHistory(); showToast('Historia wyczyszczona','info');
    }
    
    function deleteOrder(orderId){
      const hist = getHistory();
      const idx = hist.findIndex(o => o.id === orderId);
      if (idx === -1){ showToast('Nie znaleziono zam√≥wienia do usuniƒôcia','error'); return; }
      if (!confirm('Na pewno usunƒÖƒá to zam√≥wienie?')) return;
      hist.splice(idx, 1);
      saveHistory(hist);
      renderHistory();
      showToast('Usuniƒôto zam√≥wienie','success', orderId);
    }

    function exportHistory(){
      const hist=getHistory();
      if(hist.length===0){ showToast('Brak historii do eksportu','error'); return; }
      const blob=new Blob([JSON.stringify({orders:hist},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='order-history.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('Wyeksportowano historiƒô','success');
    }

    /* ===================== Edit Mode ===================== */
    function toggleEditMode(){
      if(currentUser!=='admin') return;
      editMode=!editMode;
      $('#editBtn').textContent='‚úèÔ∏è Tryb edycji: ' + (editMode?'W≈Å':'WY≈Å');
      renderAll();
    }

    /* ===================== Boot ===================== */
    (function boot(){ try {
      items = JSON.parse(JSON.stringify(DEFAULT_DATA));
      initCart();
      $('#modalBackdrop').style.display='none';
      $('#adminLoginModal').style.display='none';
      $('#historyModal').style.display='none';
    } catch(e){ console.error('Init error', e); if (typeof showToast==='function') try{showToast('B≈ÇƒÖd inicjalizacji','error');}catch{} } })();
  </script>



<style>
#activityOverlayClean{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  background: transparent;           /* bez bia≈Çego pasa */
  overflow: hidden;                  /* bez podw√≥jnych scrolli */
}
#activityOverlayClean.show{ display:block; }
#activityOverlayClean .close-activity{
  position: fixed; top: 12px; right: 12px;
  border-radius: 999px; padding: 8px 12px; border: 1px solid rgba(0,0,0,.15);
  background: rgba(255,255,255,.9); font-weight: 700; cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,.15);
  z-index: 10000;
}
#activityOverlayClean .wrap{
  position: absolute; inset: 0;
  padding-top: 0;                     /* pe≈Çny ekran bez marginesu */
}
#activityOverlayClean iframe{
  width: 100vw;                       /* pe≈Çna szeroko≈õƒá okna */
  height: 100vh;                      /* pe≈Çna wysoko≈õƒá okna */
  border: 0; display: block;
}
</style>


<section id="activityOverlayClean" aria-hidden="true">
  <button class="close-activity" onclick="closeActivityClean()">‚úñ Zamknij</button>
  <div class="wrap">
    <iframe id="activityFrame" title="Aktywno≈õƒá"></iframe>
  </div>
</section>
<script>
// Admin-only gate expects a global currentUser==='admin' (nie zmieniam tego co masz)


function openActivityClean(){
  try{ if (typeof currentUser !== 'undefined' && currentUser !== 'admin') { if (typeof showToast === 'function') showToast('Dostƒôp tylko dla administratora','error'); return; } }catch(e){}
  var el = document.getElementById('activityOverlayClean');
  var fr = document.getElementById('activityFrame');
  if (el && fr) {
    if (!fr.dataset.loaded) {
      // Decode base64 into UTF-8 string via TextDecoder to avoid "krzaki"
      var b64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9InBsIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9InV0Zi04IiAvPgo8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiIC8+Cjx0aXRsZT5Ba3R5d25vxZvEhyB6ZXNwb8WCdSDigJQgNyBkbmk8L3RpdGxlPgo8c3R5bGU+CiAgOnJvb3R7CiAgICAtLWJnLWdyYWQ6IHJhZGlhbC1ncmFkaWVudCgxMjAwcHggNjAwcHggYXQgMTUlIDEwJSwgIzNhMTc3MiAwJSwgIzJhMTA1NCAzNSUsICMxYzBmM2EgNzAlLCAjMTIwYTI1IDEwMCUpOwogICAgLS1wYW5lbDogcmdiYSgyNTUsMjU1LDI1NSwuMDYpOwogICAgLS1wYW5lbC1zdHJvbmc6IHJnYmEoMjU1LDI1NSwyNTUsLjA5KTsKICAgIC0tcGFuZWwtaG92ZXI6IHJnYmEoMjU1LDI1NSwyNTUsLjEyKTsKICAgIC0tdGV4dDojRURFN0ZGOyAtLW11dGVkOiNCQ0FGRTM7CiAgICAtLWJvcmRlcjogcmdiYSgyNTUsMjU1LDI1NSwuMTIpOwogICAgLS1hY2NlbnQ6IzhiNWNmNjsgLS1hY2NlbnQtMjojMjJkM2VlOyAtLWRhbmdlcjojZjg3MTcxOwoKICAgIC0tc3RhdHVzLWFrdHl3bnk6IzIyYzU1ZTsKICAgIC0tc3RhdHVzLWJyYWs6I2VmNDQ0NDsKICAgIC0tc3RhdHVzLXVybG9wOiNjMDg0ZmM7CiAgICAtLXN0YXR1cy11c3ByYXc6I2ZiYmYyNDsKCiAgICAtLXJhZGl1czoxNnB4OwogICAgLS1zaGFkb3c6IDAgMTBweCAzMHB4IHJnYmEoMCwwLDAsLjQ1KSwgaW5zZXQgMCAxcHggMCByZ2JhKDI1NSwyNTUsMjU1LC4wNSk7CgogICAgLS1oaWdobGlnaHQtdG9kYXktYmc6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMzQsMjExLDIzOCwwLjI1KSwgcmdiYSgxMzksOTIsMjQ2LDAuMjUpKTsKICAgIC0taGlnaGxpZ2h0LXRvZGF5LWJvcmRlcjogcmdiYSgzNCwyMTEsMjM4LDAuNyk7CiAgfQogICp7Ym94LXNpemluZzpib3JkZXItYm94fQogIGJvZHl7bWFyZ2luOjA7Y29sb3I6dmFyKC0tdGV4dCk7Zm9udDoxNHB4LzEuNDUgSW50ZXIsc3lzdGVtLXVpLFNlZ29lIFVJLFJvYm90byxVYnVudHUsQ2FudGFyZWxsLE5vdG8gU2FucyxzYW5zLXNlcmlmO2JhY2tncm91bmQ6dmFyKC0tYmctZ3JhZCl9CgogIGhlYWRlcntwb3NpdGlvbjpzdGlja3k7dG9wOjA7ei1pbmRleDoxMDtiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTJweCkgc2F0dXJhdGUoMTIwJSk7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKTtiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDEzLDcsMjQsLjc1KSwgcmdiYSgxMyw3LDI0LC4zNSkpO30KICAuY29udGFpbmVye21heC13aWR0aDoxMTYwcHg7bWFyZ2luOjAgYXV0bztwYWRkaW5nOjE2cHh9CiAgaDF7Zm9udC1zaXplOjIycHg7bWFyZ2luOjAgMCA4cHh9CiAgLnRvb2xiYXJ7ZGlzcGxheTpmbGV4O2dhcDoxMHB4O2ZsZXgtd3JhcDp3cmFwO2FsaWduLWl0ZW1zOmNlbnRlcn0KICBidXR0b24sLmJ0bntiYWNrZ3JvdW5kOiB2YXIoLS1wYW5lbCk7Y29sb3I6IHZhcigtLXRleHQpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjEwcHggMTRweDtib3JkZXItcmFkaXVzOjk5OXB4O2N1cnNvcjpwb2ludGVyO2JveC1zaGFkb3c6IHZhcigtLXNoYWRvdyk7dHJhbnNpdGlvbjouMnN9CiAgYnV0dG9uOmhvdmVye2JhY2tncm91bmQ6dmFyKC0tcGFuZWwtaG92ZXIpfQogIC5idG4tcHJpbWFyeXtiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCB2YXIoLS1hY2NlbnQpLCB2YXIoLS1hY2NlbnQtMikpOyBjb2xvcjojMGIwNjIwOyBib3JkZXItY29sb3I6dHJhbnNwYXJlbnR9CiAgLmJ0bi1kYW5nZXJ7YmFja2dyb3VuZDp2YXIoLS1wYW5lbCk7Ym9yZGVyLWNvbG9yOnJnYmEoMjQ4LDExMywxMTMsLjUpO2NvbG9yOiNmZWNhY2F9CiAgLmJ0bi1naG9zdHtiYWNrZ3JvdW5kOnRyYW5zcGFyZW50O2JvcmRlcjoxcHggZGFzaGVkIHZhcigtLWJvcmRlcik7Y29sb3I6dmFyKC0tdGV4dCl9CiAgaW5wdXRbdHlwZT0idGV4dCJde2JhY2tncm91bmQ6IHZhcigtLXBhbmVsLXN0cm9uZyk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2NvbG9yOnZhcigtLXRleHQpO3BhZGRpbmc6MTBweCAxNHB4O2JvcmRlci1yYWRpdXM6OTk5cHh9CiAgLmhpbnR7Y29sb3I6dmFyKC0tbXV0ZWQpfQoKICAvKiBUQUJMSUNBICovCiAgdGFibGUjYm9hcmR7d2lkdGg6MTAwJTtib3JkZXItY29sbGFwc2U6c2VwYXJhdGU7Ym9yZGVyLXNwYWNpbmc6MCAxNHB4O21hcmdpbjoxOHB4IDB9CiAgI2JvYXJkIHRoZWFkIHRoe3Bvc2l0aW9uOnN0aWNreTt0b3A6OTJweDtiYWNrZ3JvdW5kOnJnYmEoMjU1LDI1NSwyNTUsLjA3KTtiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCk7ei1pbmRleDo0O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjEycHh9CiAgI2JvYXJkIHRoLCAjYm9hcmQgdGR7cGFkZGluZzoxMnB4IDEycHg7Ym9yZGVyLXRvcDoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpfQogICNib2FyZCB0Ym9keSB0cntiYWNrZ3JvdW5kOnZhcigtLXBhbmVsKTsgYm9yZGVyLXJhZGl1czp2YXIoLS1yYWRpdXMpOyBib3gtc2hhZG93OiB2YXIoLS1zaGFkb3cpfQogICNib2FyZCB0Ym9keSB0cjpob3ZlcntiYWNrZ3JvdW5kOnZhcigtLXBhbmVsLWhvdmVyKX0KICAjYm9hcmQgdGg6Zmlyc3QtY2hpbGQsICNib2FyZCB0ZDpmaXJzdC1jaGlsZHtib3JkZXItbGVmdDoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItdG9wLWxlZnQtcmFkaXVzOnZhcigtLXJhZGl1cyk7Ym9yZGVyLWJvdHRvbS1sZWZ0LXJhZGl1czp2YXIoLS1yYWRpdXMpfQogICNib2FyZCB0aDpsYXN0LWNoaWxkLCAjYm9hcmQgdGQ6bGFzdC1jaGlsZHtib3JkZXItcmlnaHQ6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXRvcC1yaWdodC1yYWRpdXM6dmFyKC0tcmFkaXVzKTtib3JkZXItYm90dG9tLXJpZ2h0LXJhZGl1czp2YXIoLS1yYWRpdXMpfQogIC5jb2wtaWR4e3dpZHRoOjQ4cHg7dGV4dC1hbGlnbjpjZW50ZXJ9CiAgLm5hbWUtY2VsbHtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDoxMHB4fQogIC5uYW1le2ZvbnQtd2VpZ2h0OjcwMH0KICAuYWN0aW9uc3ttYXJnaW4tbGVmdDphdXRvOyBkaXNwbGF5OmZsZXg7IGdhcDo4cHh9CiAgLm5hbWVbY29udGVudGVkaXRhYmxlPSJ0cnVlIl17b3V0bGluZToycHggZGFzaGVkICM3YzNhZWQ7IHBhZGRpbmc6MnB4IDZweDsgYm9yZGVyLXJhZGl1czo4cHg7IGJhY2tncm91bmQ6cmdiYSgxMzksOTIsMjQ2LC4xMil9CgogIC8qIER6aXNpYWogKi8KICAuZGF5LXRvZGF5LWhlYWRlcntiYWNrZ3JvdW5kOiB2YXIoLS1oaWdobGlnaHQtdG9kYXktYmcpICFpbXBvcnRhbnQ7Ym9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWhpZ2hsaWdodC10b2RheS1ib3JkZXIpICFpbXBvcnRhbnQ7Zm9udC13ZWlnaHQ6IGJvbGQ7Y29sb3I6ICNmZmYgIWltcG9ydGFudDt0ZXh0LXNoYWRvdzogMCAwIDZweCByZ2JhKDM0LDIxMSwyMzgsMC45KX0KICB0ZC5kYXktdG9kYXl7YmFja2dyb3VuZDogdmFyKC0taGlnaGxpZ2h0LXRvZGF5LWJnKSAhaW1wb3J0YW50O2JvcmRlci1sZWZ0OiAycHggc29saWQgdmFyKC0taGlnaGxpZ2h0LXRvZGF5LWJvcmRlcikgIWltcG9ydGFudDtib3JkZXItcmlnaHQ6IDJweCBzb2xpZCB2YXIoLS1oaWdobGlnaHQtdG9kYXktYm9yZGVyKSAhaW1wb3J0YW50fQoKICAuc3RhdHVze2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OmNlbnRlcjttaW4taGVpZ2h0OjQwcHg7Ym9yZGVyLWxlZnQ6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJpZ2h0OjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2N1cnNvcjpwb2ludGVyO3VzZXItc2VsZWN0Om5vbmU7Ym9yZGVyLXJhZGl1czoxMnB4O2JhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpfQogIC5zdGF0dXMgc3Bhbntmb250LXdlaWdodDo3MDB9CiAgLnMtYWt0eXduYXtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMzQsMTk3LDk0LC4yMiksIHJnYmEoMzQsMTk3LDk0LC4wOCkpfQogIC5zLWFrdHl3bmEgc3Bhbntjb2xvcjp2YXIoLS1zdGF0dXMtYWt0eXdueSl9CiAgLnMtYnJha3tiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMjM5LDY4LDY4LC4yMiksIHJnYmEoMjM5LDY4LDY4LC4wOCkpfQogIC5zLWJyYWsgc3Bhbntjb2xvcjp2YXIoLS1zdGF0dXMtYnJhayl9CiAgLnMtdXJsb3B7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCByZ2JhKDE5MiwxMzIsMjUyLC4yMiksIHJnYmEoMTkyLDEzMiwyNTIsLjA4KSl9CiAgLnMtdXJsb3Agc3Bhbntjb2xvcjp2YXIoLS1zdGF0dXMtdXJsb3ApfQogIC5zLXVzcHJhd3tiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIHJnYmEoMjUxLDE5MSwzNiwuMjIpLCByZ2JhKDI1MSwxOTEsMzYsLjA4KSl9CiAgLnMtdXNwcmF3IHNwYW57Y29sb3I6dmFyKC0tc3RhdHVzLXVzcHJhdyl9CgogIC5sZWdlbmR7ZGlzcGxheTpmbGV4O2dhcDoxMHB4O2ZsZXgtd3JhcDp3cmFwfQogIC5waWxse2Rpc3BsYXk6aW5saW5lLWZsZXg7Z2FwOjhweDthbGlnbi1pdGVtczpjZW50ZXI7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6OTk5cHg7cGFkZGluZzo4cHggMTJweDtiYWNrZ3JvdW5kOnZhcigtLXBhbmVsKX0KICAuZG90e3dpZHRoOjEwcHg7aGVpZ2h0OjEwcHg7Ym9yZGVyLXJhZGl1czo5OTlweH0KICAuZG90LmFrdHl3bmF7YmFja2dyb3VuZDp2YXIoLS1zdGF0dXMtYWt0eXdueSl9CiAgLmRvdC5icmFre2JhY2tncm91bmQ6dmFyKC0tc3RhdHVzLWJyYWspfQogIC5kb3QudXJsb3B7YmFja2dyb3VuZDp2YXIoLS1zdGF0dXMtdXJsb3ApfQogIC5kb3QudXNwcmF3e2JhY2tncm91bmQ6dmFyKC0tc3RhdHVzLXVzcHJhdyl9CgogIC8qIFBPRFNVTU9XQU5JRSAqLwogICNzdW1tYXJ5e21hcmdpbi10b3A6MTRweDsgYmFja2dyb3VuZDpyZ2JhKDI1NSwyNTUsMjU1LC4wNyk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTsgYm9yZGVyLXJhZGl1czoxNnB4OyBib3gtc2hhZG93OiB2YXIoLS1zaGFkb3cpOyBvdmVyZmxvdzpoaWRkZW59CiAgI3N1bW1hcnlIZWFkZXJ7ZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBwYWRkaW5nOjEwcHggMTJweH0KICAjdG9nZ2xlU3VtbWFyeXtiYWNrZ3JvdW5kOiB2YXIoLS1wYW5lbCk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTsgYm9yZGVyLXJhZGl1czo5OTlweDsgcGFkZGluZzo2cHggMTBweDsgY3Vyc29yOnBvaW50ZXJ9CiAgI3N1bW1hcnlJbm5lcntwYWRkaW5nOjEwcHggMTJweDsgYm9yZGVyLXRvcDoxcHggc29saWQgdmFyKC0tYm9yZGVyKX0KICAjc3VtbWFyeVRhYmxle3dpZHRoOjEwMCU7IGJvcmRlci1jb2xsYXBzZTpzZXBhcmF0ZTsgYm9yZGVyLXNwYWNpbmc6MH0KICAjc3VtbWFyeVRhYmxlIHRoLCNzdW1tYXJ5VGFibGUgdGR7cGFkZGluZzo4cHggMTBweDsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKX0KICAjc3VtbWFyeVRhYmxlIHRyOmxhc3QtY2hpbGQgdGR7Ym9yZGVyLWJvdHRvbTpub25lfQogICNzdW1tYXJ5LmNvbGxhcHNlZCAjc3VtbWFyeUlubmVye2Rpc3BsYXk6bm9uZX0KICAjc3VtbWFyeSAucGN0e29wYWNpdHk6Ljl9CiAgI3N1bW1hcnkgLmNvbC1pZHh7d2lkdGg6NDhweDt0ZXh0LWFsaWduOmNlbnRlcn0KPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8aGVhZGVyPgogICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgPGgxPvCfk4UgQWt0eXdub8WbxIcgemVzcG/FgnUg4oCUIDcgZG5pPC9oMT4KICAgICAgPGRpdiBjbGFzcz0idG9vbGJhciI+CiAgICAgICAgPGJ1dHRvbiBpZD0icHJldjciPuKftSBQb3ByemVkbmkgdHlkemllxYQ8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJ0b2RheSIgY2xhc3M9ImJ0biI+RHppc2lhajwvYnV0dG9uPgogICAgICAgIDxidXR0b24gaWQ9Im5leHQ3Ij5OYXN0xJlwbnkgdHlkemllxYQg4p+2PC9idXR0b24+CiAgICAgICAgPGRpdiBzdHlsZT0iZmxleDoxIj48L2Rpdj4KICAgICAgICA8aW5wdXQgaWQ9ImZpbHRlciIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IlN6dWthaiBvc29ieSAobGl2ZSkuLi4iIHN0eWxlPSJtaW4td2lkdGg6MjIwcHgiIC8+CiAgICAgICAgPGlucHV0IGlkPSJuZXdOYW1lIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0iRG9kYWogb3NvYsSZIChucC4gS2FzaWEpIiAvPgogICAgICAgIDxidXR0b24gaWQ9ImFkZFBlcnNvbiIgY2xhc3M9ImJ0bi1wcmltYXJ5Ij5Eb2RhajwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kIGhpbnQiPgogICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj48c3BhbiBjbGFzcz0iZG90IGFrdHl3bmEiPjwvc3Bhbj4gQWt0eXdueS9hPC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj48c3BhbiBjbGFzcz0iZG90IGJyYWsiPjwvc3Bhbj4gQnJhayBha3QuPC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj48c3BhbiBjbGFzcz0iZG90IHVybG9wIj48L3NwYW4+IFVybG9wPC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJwaWxsIj48c3BhbiBjbGFzcz0iZG90IHVzcHJhdyI+PC9zcGFuPiBVc3ByYXdpZWRsaXdpb255PC9zcGFuPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvaGVhZGVyPgoKICA8bWFpbiBjbGFzcz0iY29udGFpbmVyIj4KICAgIDxkaXYgaWQ9IndlZWtMYWJlbCIgY2xhc3M9ImhpbnQiIHN0eWxlPSJtYXJnaW4tdG9wOjEycHgiPjwvZGl2PgoKICAgIDwhLS0gVEFCTElDQSA3LUROSU9XQSAtLT4KICAgIDx0YWJsZSBpZD0iYm9hcmQiPgogICAgICA8dGhlYWQ+CiAgICAgICAgPHRyPgogICAgICAgICAgPHRoIGNsYXNzPSJjb2wtaWR4Ij4jPC90aD4KICAgICAgICAgIDx0aCBzdHlsZT0id2lkdGg6MjYwcHgiPk9zb2JhPC90aD4KICAgICAgICAgIDx0aCBjbGFzcz0iZGF5LWgiPjwvdGg+CiAgICAgICAgICA8dGggY2xhc3M9ImRheS1oIj48L3RoPgogICAgICAgICAgPHRoIGNsYXNzPSJkYXktaCI+PC90aD4KICAgICAgICAgIDx0aCBjbGFzcz0iZGF5LWgiPjwvdGg+CiAgICAgICAgICA8dGggY2xhc3M9ImRheS1oIj48L3RoPgogICAgICAgICAgPHRoIGNsYXNzPSJkYXktaCI+PC90aD4KICAgICAgICAgIDx0aCBjbGFzcz0iZGF5LWgiPjwvdGg+CiAgICAgICAgPC90cj4KICAgICAgPC90aGVhZD4KICAgICAgPHRib2R5IGlkPSJyb3dzIj48L3Rib2R5PgogICAgPC90YWJsZT4KCiAgICA8IS0tIFBPRFNVTU9XQU5JRSBQT0QgVEFCRUzEhCAtLT4KICAgIDxzZWN0aW9uIGlkPSJzdW1tYXJ5IiBjbGFzcz0iY29sbGFwc2VkIiBhcmlhLWxpdmU9InBvbGl0ZSI+CiAgICAgIDxkaXYgaWQ9InN1bW1hcnlIZWFkZXIiPgogICAgICAgIDxoMiBzdHlsZT0ibWFyZ2luOjA7Zm9udC1zaXplOjE2cHgiPlBvZHN1bW93YW5pZSB0eWdvZG5pYSAod2lkb2s6IDxzcGFuIGlkPSJzdW1SYW5nZSI+PC9zcGFuPik8L2gyPgogICAgICAgIDxidXR0b24gaWQ9InRvZ2dsZVN1bW1hcnkiIHRpdGxlPSJad2nFhC9Sb3p3acWEIj5Sb3p3acWEIOKWvDwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0ic3VtbWFyeUlubmVyIj4KICAgICAgICA8dGFibGUgaWQ9InN1bW1hcnlUYWJsZSI+CiAgICAgICAgICA8dGhlYWQ+CiAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICA8dGggY2xhc3M9ImNvbC1pZHgiPiM8L3RoPgogICAgICAgICAgICAgIDx0aCBzdHlsZT0idGV4dC1hbGlnbjpsZWZ0Ij5Pc29iYTwvdGg+CiAgICAgICAgICAgICAgPHRoPkFrdHl3bmUgZG5pPC90aD4KICAgICAgICAgICAgICA8dGg+TmllYWt0eXduZSBkbmk8L3RoPgogICAgICAgICAgICAgIDx0aCBjbGFzcz0icGN0Ij4lIGFrdHl3bm/Fm2NpPC90aD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHk+PC90Ym9keT4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KCiAgICA8cCBjbGFzcz0iaGludCI+8J+UkiBEYW5lIHphcGlzdWrEhSBzacSZIGF1dG9tYXR5Y3puaWUgdyBUd29qZWogcHJ6ZWdsxIVkYXJjZSAobG9jYWxTdG9yYWdlKS48L3A+CiAgPC9tYWluPgoKICA8Zm9vdGVyPsKpIFRhYmxpY2EgYWt0eXdub8WbY2kg4oCUIHdlcnNqYSBkZW1vPC9mb290ZXI+Cgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBjb25zdCBTVE9SQUdFX0tFWSA9ICdha3R5d25vc2NfdjEzJzsKCiAgLy8gPT09IERhdHkgKHBvbW9jbmljemUpID09PQogIGZ1bmN0aW9uIHN0YXJ0T2ZXZWVrKGQpeyBjb25zdCB4PW5ldyBEYXRlKGQpOyBjb25zdCBkYXk9KHguZ2V0RGF5KCkrNiklNzsgeC5zZXRIb3VycygwLDAsMCwwKTsgeC5zZXREYXRlKHguZ2V0RGF0ZSgpLWRheSk7IHJldHVybiB4OyB9CiAgZnVuY3Rpb24gZm10RGF0ZShkKXsgcmV0dXJuIGQudG9Mb2NhbGVEYXRlU3RyaW5nKCdwbC1QTCcse3dlZWtkYXk6J3Nob3J0JywgZGF5OicyLWRpZ2l0JywgbW9udGg6J3Nob3J0J30pOyB9CiAgZnVuY3Rpb24gdG9JU09EYXRlKGQpeyBjb25zdCB5PWQuZ2V0RnVsbFllYXIoKSwgbT0oZC5nZXRNb250aCgpKzErJycpLnBhZFN0YXJ0KDIsJzAnKSwgZGE9KGQuZ2V0RGF0ZSgpKycnKS5wYWRTdGFydCgyLCcwJyk7IHJldHVybiBgJHt5fS0ke219LSR7ZGF9YDsgfQoKICAvLyA9PT0gUGFtacSZxIcgPT09CiAgZnVuY3Rpb24gbG9hZCgpeyB0cnl7IHJldHVybiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZKSk7IH1jYXRjaChlKXsgcmV0dXJuIG51bGw7IH0gfQogIGZ1bmN0aW9uIHNhdmUoKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVksIEpTT04uc3RyaW5naWZ5KHN0YXRlKSk7IH0KCiAgY29uc3Qgc3RhdGUgPSBsb2FkKCkgfHwgewogICAgd2Vla1N0YXJ0SVNPOiBzdGFydE9mV2VlayhuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpLAogICAgcGVvcGxlOiBbCiAgICAgICdLYXNrdScsJ1Npd2EnLCdXaWxrdScsJ0Rvbm5hJywnTW9yaScsJ0dyenliJywnTG9jemVrJywnSmFuaW5hJywnR8OzcmthJywnTWHFgnknLCdGaXR6JywnTW9jaGknLCdNaWtlJywnRHpvbmknLCdLYXNhJywnWmVicmEnLCdIYXJwdW5rYScsJ1N0cmFjaHUnLCdDaXBlaycsJ1plcsOzd2thJywnV2llcnTFgm8nLCdGcmFuZWsnLCdDaWNoeScsJ0tzYXdjaW8nLCdEcmFrZScsJ0thc3praWV0JywnTWFzxYJvJywnRXNjb2JhcicsJ0xlbmN6ZWsnLCdNYWduZXonLCdYc2VudCcsJ0dhcmNpYScsJ1NwYXlzb24nLCdSYWRpbycsJ0RhdmlkJywnQ3phcm55JywnTWFyY2luJywnVG9tdXMnLCdCbGFrdScsJ05pa29zJywnTcWCb2R5JywnTG90bmlza28nLCdFbm56dScsJ01vbGVzdGVyJywnTWFqa2VsJywnUHVzdGFrJywnU2lsZW5jaWsnLCdCb2JlcicsJ1doaXRlJywnTHVjYXMnCiAgICBdLAogICAgZGF0YToge30sCiAgICBzdW1tYXJ5Q29sbGFwc2VkOiB0cnVlCiAgfTsKCiAgLy8gPT09IFN0YXR1c3kgPT09CiAgY29uc3Qgc3RhdHVzZXMgPSBbCiAgICB7Y29kZTonQUtUWVdOQScsIGxhYmVsOidBa3R5d255L2EnLCBjbHM6J3MtYWt0eXduYSd9LAogICAge2NvZGU6J0JSQUsnLCBsYWJlbDonQnJhayBha3QuJywgY2xzOidzLWJyYWsnfSwKICAgIHtjb2RlOidVUkxPUCcsIGxhYmVsOidVcmxvcCcsIGNsczoncy11cmxvcCd9LAogICAge2NvZGU6J1VTUFJBVycsIGxhYmVsOidVc3ByYXdpZWRsaXdpb255JywgY2xzOidzLXVzcHJhdyd9LAogICAge2NvZGU6JycsIGxhYmVsOifigJQnLCBjbHM6Jyd9LAogIF07CiAgY29uc3QgSU5BQ1RJVkVfU0VUID0gbmV3IFNldChbJ0JSQUsnLCdVUkxPUCcsJ1VTUFJBVycsJyddKTsKCiAgLy8gPT09IEVsZW1lbnR5ID09PQogIGNvbnN0IGVsID0gewogICAgd2Vla0xhYmVsOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2Vla0xhYmVsJyksCiAgICBoZWFkRGF5czogQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZGF5LWgnKSksCiAgICByb3dzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm93cycpLAogICAgcHJldjc6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmV2NycpLAogICAgbmV4dDc6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0NycpLAogICAgdG9kYXk6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2RheScpLAogICAgYWRkQnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkUGVyc29uJyksCiAgICBuZXdOYW1lOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmV3TmFtZScpLAogICAgZmlsdGVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsdGVyJyksCiAgICBzdW1tYXJ5OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3VtbWFyeScpLAogICAgc3VtUmFuZ2U6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdW1SYW5nZScpLAogICAgc3VtQm9keTogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3N1bW1hcnlUYWJsZSB0Ym9keScpLAogICAgdG9nZ2xlU3VtbWFyeTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvZ2dsZVN1bW1hcnknKQogIH07CgogIC8vID09PSBOYWfFgsOzd2tpIGRuaSBpIHpha3JlcyA9PT0KICBmdW5jdGlvbiByZW5kZXJIZWFkZXIoKXsKICAgIGNvbnN0IHN0YXJ0ID0gbmV3IERhdGUoc3RhdGUud2Vla1N0YXJ0SVNPKTsKICAgIGNvbnN0IGVuZCA9IG5ldyBEYXRlKHN0YXJ0KTsgZW5kLnNldERhdGUoZW5kLmdldERhdGUoKSs2KTsKICAgIGlmKGVsLndlZWtMYWJlbCkgZWwud2Vla0xhYmVsLnRleHRDb250ZW50ID0gYFR5ZHppZcWEOiAke3N0YXJ0LnRvTG9jYWxlRGF0ZVN0cmluZygncGwtUEwnKX0g4oCTICR7ZW5kLnRvTG9jYWxlRGF0ZVN0cmluZygncGwtUEwnKX1gOwogICAgaWYoZWwuc3VtUmFuZ2UpIGVsLnN1bVJhbmdlLnRleHRDb250ZW50ID0gYCR7c3RhcnQudG9Mb2NhbGVEYXRlU3RyaW5nKCdwbC1QTCcpfSDigJMgJHtlbmQudG9Mb2NhbGVEYXRlU3RyaW5nKCdwbC1QTCcpfWA7CiAgICBlbC5oZWFkRGF5cy5mb3JFYWNoKCh0aCxpKT0+ewogICAgICBjb25zdCBkPW5ldyBEYXRlKHN0YXJ0KTsgZC5zZXREYXRlKGQuZ2V0RGF0ZSgpK2kpOwogICAgICBjb25zdCBpc1RvZGF5ID0gdG9JU09EYXRlKGQpPT09dG9JU09EYXRlKG5ldyBEYXRlKCkpOwogICAgICB0aC50ZXh0Q29udGVudCA9IGZtdERhdGUoZCk7CiAgICAgIGlmKGlzVG9kYXkpIHRoLmNsYXNzTGlzdC5hZGQoJ2RheS10b2RheS1oZWFkZXInKTsgZWxzZSB0aC5jbGFzc0xpc3QucmVtb3ZlKCdkYXktdG9kYXktaGVhZGVyJyk7CiAgICB9KTsKICB9CgogIC8vID09PSBEYW5lIGtvbcOzcmVrID09PQogIGZ1bmN0aW9uIGdldENlbGxTdGF0dXMocGVyc29uLCBpc28peyByZXR1cm4gc3RhdGUuZGF0YT8uW3BlcnNvbl0/Lltpc29dIHx8ICcnOyB9CiAgZnVuY3Rpb24gc2V0Q2VsbFN0YXR1cyhwZXJzb24sIGlzbywgY29kZSl7IHN0YXRlLmRhdGFbcGVyc29uXT1zdGF0ZS5kYXRhW3BlcnNvbl18fHt9OyBzdGF0ZS5kYXRhW3BlcnNvbl1baXNvXT1jb2RlOyBzYXZlKCk7IH0KICBmdW5jdGlvbiBjeWNsZShjb2RlKXsgY29uc3QgaWR4PXN0YXR1c2VzLmZpbmRJbmRleChzPT5zLmNvZGU9PT1jb2RlKTsgcmV0dXJuIHN0YXR1c2VzWyhpZHgrMSklc3RhdHVzZXMubGVuZ3RoXS5jb2RlOyB9CgogIC8vID09PSBGaWx0cm93YW5pZSBpIG51bWVyYWNqYSA9PT0KICBmdW5jdGlvbiBmaWx0ZXJlZFBlb3BsZSgpewogICAgY29uc3QgcSA9IChlbC5maWx0ZXI/LnZhbHVlIHx8ICcnKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICAgIGlmKCFxKSByZXR1cm4gc3RhdGUucGVvcGxlLnNsaWNlKCk7CiAgICByZXR1cm4gc3RhdGUucGVvcGxlLmZpbHRlcihwPT5wLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocSkpOwogIH0KCiAgLy8gPT09IFdpZXJzeiBvc29ieSA9PT0KICBmdW5jdGlvbiByb3dUZW1wbGF0ZShwZXJzb24sIGlkeCl7CiAgICBjb25zdCB0cj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwoKICAgIGNvbnN0IGlkeFRkPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7IGlkeFRkLmNsYXNzTmFtZT0nY29sLWlkeCc7IGlkeFRkLnRleHRDb250ZW50PWlkeCsxOyB0ci5hcHBlbmRDaGlsZChpZHhUZCk7CgogICAgY29uc3QgbmFtZVRkPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7IG5hbWVUZC5jbGFzc05hbWU9J25hbWUtY2VsbCc7CiAgICBjb25zdCBuYW1lU3Bhbj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IG5hbWVTcGFuLmNsYXNzTmFtZT0nbmFtZSc7IG5hbWVTcGFuLnRleHRDb250ZW50PXBlcnNvbjsgbmFtZVNwYW4udGl0bGU9J0VkeXR1aiBuYXp3xJknOwogICAgY29uc3QgYWN0aW9ucz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IGFjdGlvbnMuY2xhc3NOYW1lPSdhY3Rpb25zJzsKICAgIGNvbnN0IGVkaXQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7IGVkaXQuY2xhc3NOYW1lPSdidG4tZ2hvc3QnOyBlZGl0LnRleHRDb250ZW50PSdFZHl0dWonOwogICAgY29uc3QgZGVsPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOyBkZWwuY2xhc3NOYW1lPSdidG4tZGFuZ2VyJzsgZGVsLnRleHRDb250ZW50PSdVc3XFhCc7CgogICAgZnVuY3Rpb24gc3RhcnRFZGl0KCl7IG5hbWVTcGFuLmNvbnRlbnRFZGl0YWJsZT0ndHJ1ZSc7IG5hbWVTcGFuLmZvY3VzKCk7IHNlbGVjdEFsbChuYW1lU3Bhbik7IH0KICAgIGZ1bmN0aW9uIGZpbmlzaEVkaXQoKXsKICAgICAgbmFtZVNwYW4uY29udGVudEVkaXRhYmxlPSdmYWxzZSc7CiAgICAgIGNvbnN0IG5ld05hbWU9KG5hbWVTcGFuLnRleHRDb250ZW50fHwnJykudHJpbSgpOwogICAgICBpZighbmV3TmFtZSB8fCBuZXdOYW1lPT09cGVyc29uKSB7IG5hbWVTcGFuLnRleHRDb250ZW50PXBlcnNvbjsgcmV0dXJuOyB9CiAgICAgIGlmKHN0YXRlLnBlb3BsZS5pbmNsdWRlcyhuZXdOYW1lKSkgeyBhbGVydCgnVGFrYSBvc29iYSBqdcW8IGlzdG5pZWplLicpOyBuYW1lU3Bhbi50ZXh0Q29udGVudD1wZXJzb247IHJldHVybjsgfQogICAgICBzdGF0ZS5kYXRhW25ld05hbWVdPXN0YXRlLmRhdGFbcGVyc29uXXx8e307IGRlbGV0ZSBzdGF0ZS5kYXRhW3BlcnNvbl07CiAgICAgIGNvbnN0IG9yaWdJZHg9c3RhdGUucGVvcGxlLmluZGV4T2YocGVyc29uKTsgaWYob3JpZ0lkeD4tMSkgc3RhdGUucGVvcGxlW29yaWdJZHhdPW5ld05hbWU7CiAgICAgIHBlcnNvbj1uZXdOYW1lOyBzYXZlKCk7IHJlbmRlckFsbCgpOwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsRWRpdCgpeyBuYW1lU3Bhbi5jb250ZW50RWRpdGFibGU9J2ZhbHNlJzsgbmFtZVNwYW4udGV4dENvbnRlbnQ9cGVyc29uOyB9CgogICAgZWRpdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHN0YXJ0RWRpdCk7CiAgICBuYW1lU3Bhbi5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57IGlmKGUua2V5PT09J0VudGVyJyl7IGUucHJldmVudERlZmF1bHQoKTsgZmluaXNoRWRpdCgpOyB9IGlmKGUua2V5PT09J0VzY2FwZScpeyBlLnByZXZlbnREZWZhdWx0KCk7IGNhbmNlbEVkaXQoKTsgfSB9KTsKICAgIG5hbWVTcGFuLmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBmaW5pc2hFZGl0KTsKICAgIGRlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsKCk9PnsgaWYoY29uZmlybShgVXN1bsSFxIcgb3NvYsSZIOKAniR7cGVyc29ufeKAnT9gKSl7IHN0YXRlLnBlb3BsZT1zdGF0ZS5wZW9wbGUuZmlsdGVyKHA9PnAhPT1wZXJzb24pOyBkZWxldGUgc3RhdGUuZGF0YVtwZXJzb25dOyBzYXZlKCk7IHJlbmRlckFsbCgpOyB9fSk7CgogICAgYWN0aW9ucy5hcHBlbmQoZWRpdCwgZGVsKTsKICAgIG5hbWVUZC5hcHBlbmQobmFtZVNwYW4sIGFjdGlvbnMpOyB0ci5hcHBlbmRDaGlsZChuYW1lVGQpOwoKICAgIGNvbnN0IHN0YXJ0PW5ldyBEYXRlKHN0YXRlLndlZWtTdGFydElTTyk7CiAgICBmb3IobGV0IGk9MDtpPDc7aSsrKXsKICAgICAgY29uc3QgZD1uZXcgRGF0ZShzdGFydCk7IGQuc2V0RGF0ZShkLmdldERhdGUoKStpKTsgY29uc3QgaXNvPXRvSVNPRGF0ZShkKTsKICAgICAgY29uc3QgdGQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTsKICAgICAgaWYodG9JU09EYXRlKG5ldyBEYXRlKCkpPT09aXNvKSB0ZC5jbGFzc0xpc3QuYWRkKCdkYXktdG9kYXknKTsKICAgICAgY29uc3Qgc3RhdHVzRGl2PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBzdGF0dXNEaXYuY2xhc3NOYW1lPSdzdGF0dXMnOyBzdGF0dXNEaXYudGFiSW5kZXg9MDsKICAgICAgc3RhdHVzRGl2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywoKT0+eyBjb25zdCBuZXh0PWN5Y2xlKGdldENlbGxTdGF0dXMocGVyc29uLCBpc28pKTsgc2V0Q2VsbFN0YXR1cyhwZXJzb24sIGlzbywgbmV4dCk7IHVwZGF0ZVN0YXR1c1ZpZXcoc3RhdHVzRGl2LG5leHQpOyB1cGRhdGVTdW1tYXJ5KCk7IH0pOwogICAgICBzdGF0dXNEaXYuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsKGUpPT57IGlmKGUua2V5PT09J0VudGVyJ3x8ZS5rZXk9PT0nICcpeyBlLnByZXZlbnREZWZhdWx0KCk7IHN0YXR1c0Rpdi5jbGljaygpOyB9fSk7CiAgICAgIHVwZGF0ZVN0YXR1c1ZpZXcoc3RhdHVzRGl2LCBnZXRDZWxsU3RhdHVzKHBlcnNvbiwgaXNvKSk7IHRkLmFwcGVuZENoaWxkKHN0YXR1c0Rpdik7IHRyLmFwcGVuZENoaWxkKHRkKTsKICAgIH0KICAgIHJldHVybiB0cjsKICB9CgogIGZ1bmN0aW9uIHNlbGVjdEFsbChlbCl7IGNvbnN0IHJhbmdlPWRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7IHJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhlbCk7IGNvbnN0IHNlbD13aW5kb3cuZ2V0U2VsZWN0aW9uKCk7IHNlbC5yZW1vdmVBbGxSYW5nZXMoKTsgc2VsLmFkZFJhbmdlKHJhbmdlKTsgfQoKICBmdW5jdGlvbiB1cGRhdGVTdGF0dXNWaWV3KGVsRGl2LCBjb2RlKXsgY29uc3Qgcz1zdGF0dXNlcy5maW5kKHg9PnguY29kZT09PWNvZGUpfHxzdGF0dXNlc1tzdGF0dXNlcy5sZW5ndGgtMV07IGVsRGl2LmNsYXNzTmFtZT1gc3RhdHVzICR7cy5jbHN9YC50cmltKCk7IGVsRGl2LmlubmVySFRNTD1gPHNwYW4+JHtzLmxhYmVsfHwnJm5ic3A7J308L3NwYW4+YDsgfQoKICBmdW5jdGlvbiByZW5kZXJUYWJsZSgpewogICAgZWwucm93cy5pbm5lckhUTUw9Jyc7CiAgICBmaWx0ZXJlZFBlb3BsZSgpLmZvckVhY2goKHAsaSk9PiBlbC5yb3dzLmFwcGVuZENoaWxkKHJvd1RlbXBsYXRlKHAsaSkpICk7CiAgfQoKICAvLyA9PT0gUG9kc3Vtb3dhbmllID09PQogIGZ1bmN0aW9uIHVwZGF0ZVN1bW1hcnkoKXsKICAgIGNvbnN0IHN0YXJ0PW5ldyBEYXRlKHN0YXRlLndlZWtTdGFydElTTyk7CiAgICBjb25zdCBkYXlzPUFycmF5LmZyb20oe2xlbmd0aDo3fSwoXyxpKT0+eyBjb25zdCBkPW5ldyBEYXRlKHN0YXJ0KTsgZC5zZXREYXRlKGQuZ2V0RGF0ZSgpK2kpOyByZXR1cm4gdG9JU09EYXRlKGQpOyB9KTsKCiAgICBjb25zdCBsaXN0ID0gZmlsdGVyZWRQZW9wbGUoKTsKICAgIGNvbnN0IHJvd3M9bGlzdC5tYXAoKHBlcnNvbiwgaSk9PnsKICAgICAgbGV0IGFjdGl2ZT0wLGluYWN0aXZlPTA7CiAgICAgIGZvcihjb25zdCBpc28gb2YgZGF5cyl7CiAgICAgICAgY29uc3QgY29kZT1nZXRDZWxsU3RhdHVzKHBlcnNvbiwgaXNvKTsKICAgICAgICBpZihjb2RlPT09J0FLVFlXTkEnKSBhY3RpdmUrKzsgZWxzZSBpZihJTkFDVElWRV9TRVQuaGFzKGNvZGUpKSBpbmFjdGl2ZSsrOwogICAgICB9CiAgICAgIGNvbnN0IHBjdD1kYXlzLmxlbmd0aD9NYXRoLnJvdW5kKChhY3RpdmUvZGF5cy5sZW5ndGgpKjEwMCk6MDsKICAgICAgcmV0dXJuIHtpLCBwZXJzb24sIGFjdGl2ZSwgaW5hY3RpdmUsIHBjdH07CiAgICB9KTsKCiAgICBlbC5zdW1Cb2R5LmlubmVySFRNTCA9IHJvd3MubWFwKHI9PgogICAgICBgPHRyPgogICAgICAgIDx0ZCBjbGFzcz0iY29sLWlkeCI+JHtyLmkrMX08L3RkPgogICAgICAgIDx0ZCBzdHlsZT0idGV4dC1hbGlnbjpsZWZ0Ij4ke2VzY2FwZUh0bWwoci5wZXJzb24pfTwvdGQ+CiAgICAgICAgPHRkIHN0eWxlPSJ0ZXh0LWFsaWduOmNlbnRlciI+JHtyLmFjdGl2ZX08L3RkPgogICAgICAgIDx0ZCBzdHlsZT0idGV4dC1hbGlnbjpjZW50ZXIiPiR7ci5pbmFjdGl2ZX08L3RkPgogICAgICAgIDx0ZCBzdHlsZT0idGV4dC1hbGlnbjpjZW50ZXIiIGNsYXNzPSJwY3QiPiR7ci5wY3R9JTwvdGQ+CiAgICAgIDwvdHI+YAogICAgKS5qb2luKCcnKTsKICB9CgogIGZ1bmN0aW9uIGVzY2FwZUh0bWwocyl7IHJldHVybiBzLnJlcGxhY2UoL1smPD4iJ10vZywgYz0+KHsiJiI6IiZhbXA7IiwiPCI6IiZsdDsiLCI+IjoiJmd0OyIsIlwiIjoiJnF1b3Q7IiwiJyI6IiYjMzk7In1bY10pKTsgfQoKICBmdW5jdGlvbiBhcHBseVN1bW1hcnlDb2xsYXBzZWQoKXsgaWYoc3RhdGUuc3VtbWFyeUNvbGxhcHNlZCkgeyBlbC5zdW1tYXJ5LmNsYXNzTGlzdC5hZGQoJ2NvbGxhcHNlZCcpOyBlbC50b2dnbGVTdW1tYXJ5LnRleHRDb250ZW50PSdSb3p3acWEIOKWvCc7IH0gZWxzZSB7IGVsLnN1bW1hcnkuY2xhc3NMaXN0LnJlbW92ZSgnY29sbGFwc2VkJyk7IGVsLnRvZ2dsZVN1bW1hcnkudGV4dENvbnRlbnQ9J1p3acWEIOKWsic7IH0gfQoKICAvLyA9PT0gVG9vbGJhciA9PT0KICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJldjcnKS5vbmNsaWNrID0gKCk9PnsgY29uc3QgZD1uZXcgRGF0ZShzdGF0ZS53ZWVrU3RhcnRJU08pOyBkLnNldERhdGUoZC5nZXREYXRlKCktNyk7IHN0YXRlLndlZWtTdGFydElTTz1kLnRvSVNPU3RyaW5nKCk7IHNhdmUoKTsgcmVuZGVyQWxsKCk7IH07CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25leHQ3Jykub25jbGljayA9ICgpPT57IGNvbnN0IGQ9bmV3IERhdGUoc3RhdGUud2Vla1N0YXJ0SVNPKTsgZC5zZXREYXRlKGQuZ2V0RGF0ZSgpKzcpOyBzdGF0ZS53ZWVrU3RhcnRJU089ZC50b0lTT1N0cmluZygpOyBzYXZlKCk7IHJlbmRlckFsbCgpOyB9OwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2RheScpLm9uY2xpY2sgID0gKCk9Pnsgc3RhdGUud2Vla1N0YXJ0SVNPPXN0YXJ0T2ZXZWVrKG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCk7IHNhdmUoKTsgcmVuZGVyQWxsKCk7IH07CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkZFBlcnNvbicpLm9uY2xpY2sgPSAoKT0+eyBjb25zdCBuYW1lPShlbC5uZXdOYW1lLnZhbHVlfHwnJykudHJpbSgpOyBpZighbmFtZSkgcmV0dXJuOyBpZihzdGF0ZS5wZW9wbGUuaW5jbHVkZXMobmFtZSkpeyBhbGVydCgnVGFrYSBvc29iYSBqdcW8IGlzdG5pZWplLicpOyByZXR1cm47IH0gc3RhdGUucGVvcGxlLnB1c2gobmFtZSk7IHNhdmUoKTsgZWwubmV3TmFtZS52YWx1ZT0nJzsgcmVuZGVyQWxsKCk7IH07CiAgZWwubmV3TmFtZS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywoZSk9PnsgaWYoZS5rZXk9PT0nRW50ZXInKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkUGVyc29uJykuY2xpY2soKTsgfX0pOwogIGVsLmZpbHRlcj8uYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKT0+eyByZW5kZXJBbGwoKTsgfSk7CiAgZWwudG9nZ2xlU3VtbWFyeS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IHN0YXRlLnN1bW1hcnlDb2xsYXBzZWQ9IXN0YXRlLnN1bW1hcnlDb2xsYXBzZWQ7IHNhdmUoKTsgYXBwbHlTdW1tYXJ5Q29sbGFwc2VkKCk7IH0pOwoKICAvLyA9PT0gTWlncmFjamEgPT09CiAgKGZ1bmN0aW9uIG1pZ3JhdGUoKXsgbGV0IGNoYW5nZWQ9ZmFsc2U7IGZvcihjb25zdCBbcGVyc29uLCBkYXlzXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZS5kYXRhfHx7fSkpeyBmb3IoY29uc3QgW2RheSwgY29kZV0gb2YgT2JqZWN0LmVudHJpZXMoZGF5cykpeyBpZihjb2RlPT09J0lOTkUnKXsgc3RhdGUuZGF0YVtwZXJzb25dW2RheV09J1VTUFJBVyc7IGNoYW5nZWQ9dHJ1ZTsgfSB9IH0gaWYoY2hhbmdlZCkgc2F2ZSgpOyB9KSgpOwoKICBmdW5jdGlvbiByZW5kZXJBbGwoKXsgcmVuZGVySGVhZGVyKCk7IHJlbmRlclRhYmxlKCk7IHVwZGF0ZVN1bW1hcnkoKTsgYXBwbHlTdW1tYXJ5Q29sbGFwc2VkKCk7IH0KICByZW5kZXJBbGwoKTsKfSkoKTsKPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==";
      var bin = atob(b64);
      var len = bin.length;
      var bytes = new Uint8Array(len);
      for (var i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      var html = new TextDecoder('utf-8').decode(bytes);
      // Write exact document so it keeps parent's origin -> localStorage dzia≈Ça
      var doc = fr.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
      fr.dataset.loaded = "1";
      <script>
  // ======== SYNC ‚ÄûAktywno≈õƒá‚Äù <-> Supabase (w iframe) ========
  (async function attachActivitySync(){
    try{
      const KEY_GUESSES = ['activityData','activity','aktywnosc','teamActivity']; // klucze, kt√≥re najpewniej trzymajƒÖ stan
      const ACTIVITY_ID = 'activity';
      const childWin = fr.contentWindow;
      const childDoc = childWin.document;

      // 1) Wczytaj z Supabase -> do localStorage w iframe (≈ºeby stara logika mog≈Ça to odczytaƒá)
      async function pullFromDB(){
        const { data, error } = await supa
          .from('app_state')
          .select('items')
          .eq('id', ACTIVITY_ID)
          .maybeSingle();
        if (error) { console.error('activity pull error', error); return; }
        const payload = (data && data.items) ? data.items : {};
        const raw = JSON.stringify(payload);
        for (const k of KEY_GUESSES){
          try {
            childWin.localStorage.setItem(k, raw);
          } catch(e){}
        }
        // Od≈õwie≈º UI w iframe (najpro≈õciej: prze≈Çaduj, bo to osobna appka)
        // Je≈õli nie chcesz pe≈Çnego reloadu, to mo≈ºesz wywo≈Çaƒá jej funkcjƒô renderujƒÖcƒÖ, je≈õli takƒÖ posiada.
        childWin.location.reload();
      }

      // 2) Patch: ka≈ºda zmiana localStorage w iframe => zapis do Supabase
      (function patchChildLocalStorage(){
        const origSet = childWin.localStorage.setItem.bind(childWin.localStorage);
        childWin.localStorage.setItem = function(k, v){
          try { origSet(k, v); } catch(e){}
          // Je≈õli wyglƒÖda na klucz od aktywno≈õci ‚Äî push do DB
          const match = /activ|akty|team/i.test(k);
          if (match){
            try{
              const obj = JSON.parse(v);
              supa.from('app_state').upsert({ id: ACTIVITY_ID, items: obj, tier: 'H' });
            }catch(e){}
          }
        };
      })();

      // 3) Realtime: zmiana w DB -> aktualizuj iframe localStorage i od≈õwie≈º
      if (!window.__activity_channel__){
        window.__activity_channel__ = supa
          .channel('activity_changes')
          .on('postgres_changes',
              { event:'*', schema:'public', table:'app_state', filter:`id=eq.${ACTIVITY_ID}` },
              () => pullFromDB()
          ).subscribe();
      }

      // 4) Pierwsze wczytanie z DB
      await pullFromDB();
    }catch(e){ console.error('attachActivitySync error', e); }
  })();
  // ======== /SYNC ‚ÄûAktywno≈õƒá‚Äù ========
</script>
    }
    el.classList.add('show'); el.setAttribute('aria-hidden','false');
    window.scrollTo(0,0);
  }
}
function closeActivityClean(){
  var el = document.getElementById('activityOverlayClean');
  if (el) { el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }
}
</script>
<!-- ===== Supabase Realtime integration ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// KONFIGURACJA ‚Äî podmie≈Ñ swoimi danymi z Supabase (Settings ‚Üí API)
const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co";
const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const STATE_ID = 'state';

/* ============== GLOBAL STATE ============== */
async function loadState(){
  const { data } = await supa
    .from('app_state')
    .select('items,tier')
    .eq('id', STATE_ID)
    .maybeSingle();

  if (data) {
    items = data.items || JSON.parse(JSON.stringify(DEFAULT_DATA));
    currentTier = data.tier || 'H';
  } else {
    items = JSON.parse(JSON.stringify(DEFAULT_DATA));
    currentTier = 'H';
    await supa.from('app_state').upsert({ id: STATE_ID, items, tier: currentTier });
  }

  if (document.querySelector('#tierSelect')) document.querySelector('#tierSelect').value = currentTier;
  if (typeof initCart === 'function') initCart();
  if (typeof renderAll === 'function') renderAll();

  supa.channel('app_state_changes')
    .on('postgres_changes',{ event: '*', schema: 'public', table: 'app_state', filter: `id=eq.${STATE_ID}` },
      (payload) => {
        const row = payload.new || payload.old || {};
        if (row.items) items = row.items;
        if (row.tier) {
          currentTier = row.tier;
          if (document.querySelector('#tierSelect')) document.querySelector('#tierSelect').value = currentTier;
        }
        if (typeof renderAll === 'function') renderAll();
      })
    .subscribe();
}

async function saveState(){
  await supa.from('app_state').upsert({ id: STATE_ID, items, tier: currentTier });
}

/* ============== HISTORY (orders) ============== */
async function getHistory(){
  const { data } = await supa
    .from('orders')
    .select('*')
    .order('at', { ascending: false });
  return (data||[]).map(o=>({ id:o.id, at:o.at, tier:o.tier, user:o.user_name, items:o.items, total:+o.total }));
}

async function addOrderToHistory(order){
  await supa.from('orders').insert({
    id: order.id,
    at: order.at,
    tier: order.tier,
    user_name: order.user,
    items: order.items,
    total: order.total
  });
}

async function deleteOrder(orderId){
  await supa.from('orders').delete().eq('id', orderId);
}
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// KONFIGURACJA ‚Äî wklej swoje dane z Settings ‚Üí API
const SUPABASE_URL = "https://unovdhrzhdcstmjgjajy.supabase.co";  // <-- TWOJE
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVub3ZkaHJ6aGRjc3RtamFqZ2l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTk0MjgsImV4cCI6MjA3MTk3NTQyOH0.VNR9tg2gjXx2PwO2M9h53j20FZ-0tDF-BNrQGa3nOQA"; // <-- TW√ìJ

// Inicjalizacja klienta ‚Äì wciƒÖ≈º wewnƒÖtrz TEGO samego <script>
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const STATE_ID = 'state';

// ... TU dalej zostaje reszta funkcji z bloku: loadState(), saveState(), getHistory(), addOrderToHistory(), itd.
</script>
</body>
</html>
